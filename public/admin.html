<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>管理</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2e;
      --border: rgba(255, 255, 255, .12);
      --text: #e8eefc;
      --muted: rgba(232, 238, 252, .72);
      --ok: #22c55e;
      --ng: #ef4444;
      --chip: rgba(255, 255, 255, .08);
      --input: #0f1930;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", "Helvetica Neue", Arial, sans-serif;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 14px 40px;
    }

    h1 {
      font-size: 20px;
      margin: 0 0 14px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
    }

    .topbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .field {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--input);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
    }

    .field label {
      font-size: 12px;
      color: var(--muted);
    }

    .field input,
    .field select {
      background: transparent;
      border: 0;
      outline: 0;
      color: var(--text);
      font-size: 13px;
      min-width: 140px;
    }

    .btn {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .btn:hover {
      background: rgba(255, 255, 255, .06);
    }

    .meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
    }

    .chip {
      background: var(--chip);
      border: 1px solid var(--border);
      padding: 5px 8px;
      border-radius: 999px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    thead th {
      text-align: left;
      font-size: 12px;
      letter-spacing: .02em;
      color: var(--muted);
      background: rgba(255, 255, 255, .04);
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    tbody td {
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      vertical-align: middle;
    }

    tbody tr:hover {
      background: rgba(255, 255, 255, .03);
    }

    .status {
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
    }

    .ok {
      color: var(--ok);
    }

    .ok .dot {
      background: var(--ok);
    }

    .ng {
      color: var(--ng);
    }

    .ng .dot {
      background: var(--ng);
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .muted {
      color: var(--muted);
    }

    .errorBox {
      margin-top: 10px;
      color: #ffb4b4;
      background: rgba(239, 68, 68, .12);
      border: 1px solid rgba(239, 68, 68, .35);
      padding: 10px 12px;
      border-radius: 10px;
      display: none;
      white-space: pre-wrap;
    }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 12px;
    }

    a {
      color: #93c5fd;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>管理ページ（adminのみ）</h1>

    <div class="card">
      <div class="topbar">
        <div class="filters">
          <div class="field">
            <label for="q">検索</label>
            <input id="q" placeholder="ユーザーID / IP" />
          </div>

          <div class="field">
            <label for="f">表示</label>
            <select id="f">
              <option value="all">すべて</option>
              <option value="fail">失敗のみ</option>
              <option value="success">成功のみ</option>
            </select>
          </div>

          <button id="reload" class="btn">更新</button>
        </div>

        <div class="meta">
          <span class="chip">表示件数: <span id="count">-</span></span>
          <span class="chip">最終更新: <span id="updated">-</span></span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>日時</th>
            <th>ユーザーID</th>
            <th>結果</th>
            <th>IP</th>
            <th>pass</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr>
            <td colspan="5" class="muted">読み込み中...</td>
          </tr>
        </tbody>
      </table>

      <div id="err" class="errorBox"></div>

      <div class="footer">
        <div>※ パスワード本文は保存・表示しません（安全のため）</div>
        <div><a href="/dashboard.html">ダッシュボードへ戻る</a></div>
      </div>
    </div>
  </div>

  <script>
    const rowsEl = document.getElementById("rows");
    const errEl = document.getElementById("err");
    const qEl = document.getElementById("q");
    const fEl = document.getElementById("f");
    const countEl = document.getElementById("count");
    const updatedEl = document.getElementById("updated");
    const reloadBtn = document.getElementById("reload");

    let raw = [];

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function fmtStatus(success) {
      if (Number(success) === 1) return `<span class="status ok"><span class="dot"></span>成功</span>`;
      return `<span class="status ng"><span class="dot"></span>失敗</span>`;
    }

    function applyFilter() {
      const q = qEl.value.trim().toLowerCase();
      const mode = fEl.value;

      let data = raw.slice();

      if (mode === "fail") data = data.filter(x => Number(x.success) === 0);
      if (mode === "success") data = data.filter(x => Number(x.success) === 1);

      if (q) {
        data = data.filter(x =>
          String(x.username ?? "").toLowerCase().includes(q) ||
          String(x.ip ?? "").toLowerCase().includes(q) ||
          String(x.password ?? "").toLowerCase().includes(q)
        );
      }

      render(data);
    }

    function render(data) {
      countEl.textContent = String(data.length);

      if (!data.length) {
        rowsEl.innerHTML = `<tr><td colspan="5" class="muted">該当なし</td></tr>`;
        return;
      }

      rowsEl.innerHTML = data.map(x => `
        <tr>
          <td class="mono">${escapeHtml(x.created_at)}</td>
          <td class="mono">${escapeHtml(x.username)}</td>
          <td>${fmtStatus(x.success)}</td>
          <td class="mono">${escapeHtml(x.ip)}</td>
          <td class="mono">${escapeHtml(x.password)}</td>
        </tr>
      `).join("");
    }

    async function load() {
      errEl.style.display = "none";
      rowsEl.innerHTML = `<tr><td colspan="5" class="muted">読み込み中...</td></tr>`;

      try {
        const r = await fetch("/api/admin/login-events", { cache: "no-store" });
        if (r.status === 401) { location.href = "/login.html"; return; }
        if (r.status === 403) { throw new Error("管理者ではありません（403）"); }
        if (!r.ok) { throw new Error(`読み込み失敗: ${r.status} ${r.statusText}`); }

        raw = await r.json();

        const now = new Date();
        updatedEl.textContent = now.toLocaleString();

        applyFilter();
      } catch (e) {
        errEl.textContent = String(e);
        errEl.style.display = "block";
        rowsEl.innerHTML = `<tr><td colspan="5" class="muted">表示できません</td></tr>`;
      }
    }

    qEl.addEventListener("input", applyFilter);
    fEl.addEventListener("change", applyFilter);
    reloadBtn.addEventListener("click", load);

    load();
  </script>
</body>

</html>